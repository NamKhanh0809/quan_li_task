<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Smart Task System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; min-height: 100vh; color: #333; padding: 20px; }
        .card { border: none; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 10px; background: #fff; }
        .task-done { opacity: 0.7; background-color: #e8f5e9; border-left: 5px solid #198754 !important; }
        .task-late { opacity: 0.6; background-color: #e9ecef; border-left: 5px solid #6c757d !important; color: #6c757d; }
        .risk-alert { background-color: #fff5f5; border-left: 5px solid #dc3545 !important; }
        .task-doing { border-left: 5px solid #0d6efd !important; }
        .kpi-badge { min-width: 60px; font-size: 0.9em; }
        .penalty-badge { font-size: 0.85em; color: #dc3545; background: #ffe6e6; border: 1px solid #dc3545; padding: 1px 6px; border-radius: 4px; }
        .scroll-area { max-height: 75vh; overflow-y: auto; padding-right: 5px; }
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .accordion-button:not(.collapsed) { background-color: #e3f2fd; color: #0d6efd; }
        .btn-trash { padding: 0; border: none; background: none; color: #dc3545; }
    </style>
</head>
<body>

    <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
        <h4 class="text-primary m-0"><i class="fas fa-chart-pie"></i> Qu·∫£n l√Ω Hi·ªáu Su·∫•t & Task</h4>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-secondary">Role: {{ role }}</span>
            {% if role == 'Member' %}
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#passModal">ƒê·ªïi Pass</button>
            {% endif %}
            <a href="/logout" class="btn btn-sm btn-danger">Tho√°t</a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} py-2 shadow-sm">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if role == 'Admin' %}
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-center text-secondary fw-bold">HI·ªÜU SU·∫§T CHUNG (GI·ªú)</h6>
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="card border-primary mb-3">
                <div class="card-header bg-white text-primary fw-bold">T·∫°o Task M·ªõi</div>
                <div class="card-body p-3">
                    <form action="/create_task" method="POST">
                        <div class="row g-2">
                            <div class="col-6"><input type="text" name="code" class="form-control form-control-sm" placeholder="M√£ (BE-01)" required></div>
                            <div class="col-6"><input type="number" name="est_hours" class="form-control form-control-sm" placeholder="Gi·ªù (h)" required></div>
                            <div class="col-12"><input type="text" name="title" class="form-control form-control-sm" placeholder="T√™n c√¥ng vi·ªác" required></div>
                            <div class="col-12"><input type="datetime-local" name="due_date" class="form-control form-control-sm" required></div>
                            <div class="col-12"><button type="submit" class="btn btn-sm btn-primary w-100">T·∫°o Task</button></div>
                        </div>
                    </form>
                </div>
            </div>

            <h6 class="text-muted border-bottom pb-2">Kho Task Chung</h6>
            <div class="scroll-area">
                {% for task in available_tasks %}
                <div class="card p-2 border-start border-secondary border-3 {% if task.status == 'Late' %}bg-light{% endif %}">
                    <div class="d-flex justify-content-between">
                        <strong>{{ task.code }}</strong>
                        <span class="badge bg-secondary" style="font-size: 0.7em">{{ task.task_type }}</span>
                    </div>
                    <div class="d-flex justify-content-between mt-1 align-items-center" style="font-size: 0.85em">
                        <span>{{ task.title }}</span>
                        {% if task.status == 'Late' and task.last_assignee_name %}
                        <span class="text-danger fw-bold bg-white px-1 rounded border border-danger">
                            <i class="fas fa-undo"></i> T·ª´: {{ task.last_assignee_name }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-2 rounded shadow-sm">
                <h5 class="text-secondary m-0">Danh S√°ch Nh√¢n Vi√™n</h5>
                <div class="d-flex gap-2">
                    <input type="text" id="adminSearch" class="form-control form-control-sm" style="width: 200px;" placeholder="üîç T√¨m...">
                    <button class="btn btn-sm btn-info text-white" data-bs-toggle="modal" data-bs-target="#historyModal">L·ªãch s·ª≠</button>
                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addMemModal">+ NV</button>
                </div>
            </div>

            <div class="accordion scroll-area" id="accordionMembers">
                {% for member, data in member_data.items() %}
                <div class="accordion-item mb-2 border shadow-sm member-group">
                    <h2 class="accordion-header">
                        <div class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ member.id }}" style="cursor: pointer;">
                            <div class="d-flex w-100 justify-content-between align-items-center me-2">
                                <span><i class="fas fa-user-circle fa-lg me-2 text-secondary"></i> <strong class="member-name">{{ member.username }}</strong></span>
                                <div class="d-flex align-items-center gap-2">
                                    {% if data.penalty > 0 %}
                                    <span class="penalty-badge">Tr·ª´: -{{ data.penalty }}</span>
                                    {% endif %}
                                    <span class="badge {% if data.kpi >= 0 %}bg-success{% else %}bg-danger{% endif %} kpi-badge">KPI: {{ data.kpi }}</span>
                                    <form action="/delete_member/{{ member.id }}" method="POST" onsubmit="return confirm('X√≥a {{ member.username }}?');" style="display:inline;">
                                        <button class="btn-trash" onclick="event.stopPropagation()"><i class="fas fa-trash-alt"></i></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </h2>
                    <div id="collapse{{ member.id }}" class="accordion-collapse collapse" data-bs-parent="#accordionMembers">
                        <div class="accordion-body bg-light p-2">
                            {% if not data.tasks %} <small class="text-muted ps-2">Ch∆∞a c√≥ task.</small> {% endif %}
                            {% for t in data.tasks %}
                            <div class="card mb-2 p-2 task-item {% if t.status == 'Done' %}task-done{% elif t.status == 'Late' %}task-late{% elif t.is_risk %}risk-alert{% else %}task-doing{% endif %}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong class="task-title">[{{ t.code }}] {{ t.title }}</strong>
                                    <span class="badge {% if t.status=='Done' %}bg-success{% elif t.status=='Late' %}bg-secondary{% elif t.is_risk %}bg-danger{% else %}bg-primary{% endif %}">{{ t.status }}</span>
                                </div>
                                <div class="d-flex justify-content-between mt-1 small align-items-center">
                                    <span>Est: {{ t.est_hours }}h {% if t.status == 'Doing' %}| {{ t.progress }}%{% endif %}</span>
                                    {% if t.status == 'Done' %}
                                        <span class="text-success fw-bold">+{{ t.est_hours }} KPI</span>
                                    {% elif t.status == 'Late' %}
                                        <span class="text-danger fw-bold">FAIL (-{{ t.est_hours * 2 }})</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="modal fade" id="addMemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="/create_member" method="POST">
                    <div class="modal-header bg-success text-white"><h5>Th√™m Nh√¢n Vi√™n</h5></div>
                    <div class="modal-body">
                        <input type="text" name="username" class="form-control mb-2" placeholder="Username" required>
                        <input type="text" name="password" class="form-control" placeholder="Password" required>
                    </div>
                    <div class="modal-footer"><button type="submit" class="btn btn-success w-100">T·∫°o</button></div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white"><h5>L·ªãch s·ª≠ Ho√†n th√†nh</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    {% if not all_done_tasks %} <p class="text-center text-muted">Tr·ªëng.</p> {% else %}
                    <table class="table table-sm table-striped">
                        <thead><tr><th>M√£</th><th>T√™n</th><th>Ng∆∞·ªùi l√†m</th><th>KPI</th></tr></thead>
                        <tbody>
                            {% for t in all_done_tasks %}
                            <tr>
                                <td>{{ t.code }}</td>
                                <td>{{ t.title }}</td>
                                <td><strong>{{ t.assignee.username if t.assignee else 'ƒê√£ x√≥a' }}</strong></td>
                                <td class="text-success">+{{ t.est_hours }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-center text-secondary fw-bold">HI·ªÜU SU·∫§T C·ª¶A T√îI</h6>
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <h5 class="text-secondary">Kho Task</h5>
            <div class="scroll-area">
                {% for task in available_tasks %}
                <div class="card p-2 border-secondary {% if task.status == 'Late' %}bg-light{% endif %}">
                    <div class="d-flex justify-content-between">
                        <strong>{{ task.code }}</strong>
                        <a href="/claim_task/{{ task.id }}" class="btn btn-sm btn-outline-primary px-3">Nh·∫≠n</a>
                    </div>
                    <small>{{ task.title }} ({{ task.est_hours }}h)</small>
                    {% if task.status == 'Late' %}<div class="text-danger small">B·ªã thu h·ªìi</div>{% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-8">
            <h5 class="text-secondary">Task C·ªßa T√¥i</h5>
            {% for task in my_tasks %}
            <div class="card p-3 mb-3 {% if task.status == 'Done' %}task-done{% elif task.is_risk %}risk-alert{% else %}task-doing{% endif %}">
                <div class="d-flex justify-content-between">
                    <h5 class="m-0">[{{ task.code }}] {{ task.title }}</h5>
                    <span class="badge {% if task.status=='Done' %}bg-success{% else %}bg-primary{% endif %}">{{ task.status }}</span>
                </div>
                <div class="small text-muted my-2">
                    Deadline: {{ task.due_date.strftime('%d/%m %H:%M') }} | Est: {{ task.est_hours }}h
                    {% if task.is_risk and task.status != 'Done' %}<span class="text-danger fw-bold ms-2">‚ö†Ô∏è TR·ªÑ!</span>{% endif %}
                </div>
                
                {% if task.status != 'Done' %}
                <form action="/update_progress/{{ task.id }}" method="POST" class="d-flex gap-2 align-items-center">
                    <input type="range" class="form-range" name="progress" min="0" max="100" value="{{ task.progress }}" oninput="this.nextElementSibling.value = this.value + '%'">
                    <output style="width: 35px; font-weight: bold;">{{ task.progress }}%</output>
                    <button type="submit" class="btn btn-sm btn-primary">L∆∞u</button>
                </form>
                {% else %}
                <div class="text-success fw-bold small"><i class="fas fa-check-circle"></i> ƒê√£ xong (+{{ task.est_hours }} KPI)</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="modal fade" id="passModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="/change_password" method="POST">
                    <div class="modal-header"><h5>ƒê·ªïi M·∫≠t Kh·∫©u</h5></div>
                    <div class="modal-body">
                        <div class="mb-2"><label class="small">M·∫≠t kh·∫©u c≈©</label><input type="password" name="old_password" class="form-control" required></div>
                        <div class="mb-2"><label class="small">M·∫≠t kh·∫©u m·ªõi</label><input type="password" name="new_password" class="form-control" required></div>
                        <div class="mb-2"><label class="small">X√°c nh·∫≠n</label><input type="password" name="confirm_password" class="form-control" required></div>
                    </div>
                    <div class="modal-footer"><button type="submit" class="btn btn-primary w-100">L∆∞u</button></div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const ctx = document.getElementById('performanceChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Kho chung (h)', 'B·ªã Thu h·ªìi (h)', 'Ho√†n th√†nh (h)', 'ƒêang l√†m (h)'],
                    datasets: [{
                        data: {{ chart_stats | tojson }},
                        backgroundColor: ['#6c757d', '#dc3545', '#198754', '#ffc107']
                    }]
                }
            });
        }

        document.getElementById('adminSearch')?.addEventListener('keyup', function() {
            let filter = this.value.toLowerCase();
            document.querySelectorAll('.member-group').forEach(group => {
                let memName = group.querySelector('.member-name').innerText.toLowerCase();
                let tasks = group.querySelectorAll('.task-item');
                let hasMatch = false;
                if(memName.includes(filter)) { group.style.display = ''; hasMatch = true; }
                tasks.forEach(t => {
                    let tName = t.querySelector('.task-title').innerText.toLowerCase();
                    if(tName.includes(filter)) {
                        t.style.display = ''; hasMatch = true;
                        group.querySelector('.accordion-collapse').classList.add('show');
                    } else {
                        if(!memName.includes(filter)) t.style.display = 'none';
                    }
                });
                if(!hasMatch) group.style.display = 'none';
            });
        });
    </script>
</body>
</html>